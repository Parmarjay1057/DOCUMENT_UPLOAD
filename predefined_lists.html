{% extends 'base.html' %}

{% block title %}ðŸ“‹ Predefined Document Lists{% endblock %}

{% block body %}
<div class="container" style="margin-left: 220px; margin-top: 20px; max-width: 900px;">
  <h1 class="mb-4">ðŸ“‹ Predefined Document Lists</h1>

  {% if messages %}
    <div class="mb-4">
      {% for message in messages %}
        <p class="text-center fade-message" style="margin: 1rem 0;">
          <b>{{ message }}</b>
        </p>
      {% endfor %}
    </div>
  {% endif %}

  <!-- New List Creation Form -->
  <div class="card mb-4 p-4 shadow-sm">
    <h3>Create New Predefined Document List</h3>
    <form method="post" action="{% url 'predefined_lists' %}">
      {% csrf_token %}
      <div class="mb-3">
        <label for="new_list_name" class="form-label">List Name <span class="text-danger">*</span></label>
        <input type="text" id="new_list_name" name="name" class="form-control" placeholder="Enter list name" required>
      </div>
      <div class="mb-3">
        <label for="new_list_description" class="form-label">Description (one document per line)</label>
        <textarea id="new_list_description" name="description" class="form-control" rows="6" placeholder="Enter one document per line"></textarea>
      </div>
      <button type="submit" name="create_list" class="btn btn-success">Create List</button>
    </form>
  </div>

  <div class="mb-4">
    <form method="get" action="{% url 'predefined_lists' %}" class="d-flex">
      <input type="text" name="search" class="form-control me-2" placeholder="Search lists..." value="{{ search_query }}">
      <button type="submit" class="btn btn-primary">Search</button>
    </form>
  </div>

  <!-- Existing Predefined Document Lists -->
  <div class="list-group">
    {% for doc_list in document_lists %}
      <div class="list-group-item rounded shadow-sm mb-2">
        {% if edit_list_id and edit_list_id|stringformat:'s' == doc_list.id|stringformat:'s' %}
          <!-- Edit Form -->
          <form method="post" action="{% url 'predefined_lists' %}">
            {% csrf_token %}
            <input type="hidden" name="edit_list" value="{{ doc_list.id }}">
            <div class="mb-3">
              <label for="name_{{ doc_list.id }}" class="form-label">List Name <span class="text-danger">*</span></label>
              <input type="text" id="name_{{ doc_list.id }}" name="name" class="form-control" value="{{ doc_list.name }}" required>
            </div>
            <div class="mb-3">
              <label for="desc_{{ doc_list.id }}" class="form-label">Description (documents, one per line)</label>
              <textarea id="desc_{{ doc_list.id }}" name="description" class="form-control" rows="6">{{ doc_list.description }}</textarea>
            </div>
            <button type="submit" name="edit_list" value="{{ doc_list.id }}" class="btn btn-success btn-sm">Save</button>
            <a href="{% url 'predefined_lists' %}" class="btn btn-secondary btn-sm ms-2">Cancel</a>
          </form>
        {% else %}
          <!-- Display List Name clickable -->
          <h4 class="fw-bold text-primary" onclick="toggleDetails('details-{{ doc_list.id }}')">
            {{ doc_list.name }}
          </h4>

          <!-- Details container hidden by default -->
          <div id="details-{{ doc_list.id }}" style="display: none; margin-top: 10px;">
            <p>
              {{ doc_list.description|linebreaksbr }}
            </p>
            <!-- Edit and Delete Buttons -->
            <form method="post" action="{% url 'predefined_lists' %}" style="display:inline;">
              {% csrf_token %}
              <input type="hidden" name="edit_list" value="{{ doc_list.id }}">
              <button type="submit" name="start_edit" value="1" class="btn btn-primary btn-sm">Edit</button>
            </form>

            <form method="post" action="{% url 'delete_predefined_list' doc_list.id %}" onsubmit="return confirm('Are you sure you want to delete this list?');" style="display:inline;">
              {% csrf_token %}
              <button type="submit" class="btn btn-danger btn-sm ms-2">Delete</button>
            </form>
          </div>
        {% endif %}
      </div><br>
    {% empty %}
      <p>No predefined document lists found.</p>
    {% endfor %}
  </div>
</div>

<script>
  function toggleDetails(id) {
    const details = document.getElementById(id);
    if (details.style.display === 'none' || details.style.display === '') {
      details.style.display = 'block';
    } else {
      details.style.display = 'none';
    }
  }

  // Optional: Auto-hide messages after 3 seconds
  document.addEventListener("DOMContentLoaded", function() {
    const messages = document.querySelectorAll('.fade-message');
    if (messages.length > 0) {
      setTimeout(() => {
        messages.forEach(message => {
          message.style.transition = "opacity 0.5s ease";
          message.style.opacity = '0';
          setTimeout(() => message.remove(), 500);
        });
      }, 3000);
    }
  });
</script>
{% endblock %}
