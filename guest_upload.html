{% extends "base_guest.html" %}

{% block title %}Document Upload Dashboard - {{ document_list_name }}{% endblock %}

{% block body %}

  <h2 class="mb-4 fw-bold text-center">Document Upload Dashboard</h2>

  {% if document_list_name %}
    <div class="alert alert-secondary mb-4 text-center">
      <strong>Requested Document List:</strong> {{ document_list_name }}
    </div>
  {% endif %}

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} fw-bold mt-3 shadow-sm rounded">
        {{ message }}
      </div>
    {% endfor %}

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(alert => {
          setTimeout(() => {
            alert.style.transition = "opacity 0.5s ease-out";
            alert.style.opacity = '0';
            setTimeout(() => {
              alert.style.display = 'none';
            }, 500);
          }, 3000);
        });
      });
    </script>
  {% endif %}

  <form method="post" enctype="multipart/form-data" class="needs-validation bg-white p-4 rounded shadow" novalidate>
    {% csrf_token %}

    <div class="mb-4">
      <label for="guest_name_input" class="form-label fw-semibold fs-5">Your Name <span class="text-danger">*</span></label>
      <input type="text" id="guest_name_input" name="guest_name" class="form-control form-control-lg shadow-sm" placeholder="Enter your full name" required>
    </div>

    <ul class="list-group mb-4 shadow-sm rounded">
      {% for item in document_list_items %}
      <li class="list-group-item document-item-{{ item.id }} d-flex flex-column flex-md-row justify-content-between align-items-center gap-3 shadow-sm" style="border-left: 5px solid #0d6efd; background: linear-gradient(90deg, #f0f4ff, #e0e7ff); border-radius: 0.375rem; transition: background-color 0.3s ease;">
        <div style="flex: 1;">
          <label class="form-label mb-1 fw-semibold" style="font-size: 1.25rem;">{{ item.title }}</label>
          {% if item.uploaded %}
            <div class="text-success fw-bold fs-6">This document is uploaded âœ…</div>
          {% else %}
            <input type="file" name="file_{{ item.id }}" accept=".pdf,.jpg,.jpeg,.png" class="form-control form-control-sm shadow-sm" style="max-width: 300px;" required>
            <!-- Inline error message for this file input -->
            <div class="invalid-file-message text-danger fw-bold" style="display:none; font-size: 1rem;"></div>
          {% endif %}
        </div>
      </li>
      {% endfor %}
    </ul>

    <div class="d-grid">
      <button type="submit" class="btn btn-primary btn-lg shadow-lg" style="background: linear-gradient(45deg, #0d6efd, #6610f2); border: none;">
        Upload All Documents
      </button>
    </div>
  </form>

  <style>
    .invalid-file-message {
      transition: opacity 0.5s ease-out;
    }
  </style>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const form = document.querySelector('.needs-validation');
      if (!form) return;

      form.addEventListener('submit', function (event) {
        let isValid = true;

        // Reset previous highlights/messages
        document.querySelectorAll('.list-group-item').forEach(li => {
          li.style.backgroundColor = "";
          const msg = li.querySelector('.invalid-file-message');
          if (msg) {
            msg.style.display = "none";
            msg.style.opacity = "1";
            msg.style.transition = "";
          }
        });

        {% for item in document_list_items %}
          {% if not item.uploaded %}
            const fileInput = form.querySelector('input[name="file_{{ item.id }}"]');
            if (fileInput && !fileInput.value) {
              isValid = false;
              const li = document.querySelector('.document-item-{{ item.id }}');
              li.style.backgroundColor = "#ffe7e7"; // light red

              const msg = li.querySelector('.invalid-file-message');
              msg.textContent = "Please select file for this document!";
              msg.style.display = "block";
              msg.style.opacity = "1";

              setTimeout(() => {
                msg.style.transition = "opacity 0.5s ease-out";
                msg.style.opacity = "0";
                setTimeout(() => {
                  msg.style.display = "none";
                  li.style.backgroundColor = "";
                  msg.style.transition = "";
                  msg.style.opacity = "1";
                }, 500);
              }, 3000);
            }
          {% endif %}
        {% endfor %}

        // Guest name validation
        const guestInput = form.querySelector('#guest_name_input');
        if (!guestInput.value.trim()) {
          guestInput.classList.add('is-invalid');
          isValid = false;
        } else {
          guestInput.classList.remove('is-invalid');
        }

        if (!isValid) {
          event.preventDefault();
          event.stopPropagation();
        } else {
          form.classList.add('was-validated');
        }
      }, false);
    });
  </script>

{% endblock %}