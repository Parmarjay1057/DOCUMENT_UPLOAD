{% extends 'base.html' %}

{% block title %}File Requests{% endblock %}

{% block body %}
<div class="container" style="margin-top: 20px;">
    {% if messages %}
        {% for message in messages %}
            <div class="fade-message text-center fw-bold" style="color: green; font-size: 1.1rem;">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <script>
    document.addEventListener("DOMContentLoaded", function () {
        const messages = document.querySelectorAll('.fade-message');
        messages.forEach(msg => {
            setTimeout(() => {
                msg.style.transition = "opacity 0.5s ease-out";
                msg.style.opacity = '0';
                setTimeout(() => { msg.style.display = 'none'; }, 500);
            }, 3000);
        });
    });
    </script>

    <h1>File Requests</h1>

    <ul class="nav nav-tabs" id="requestsTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="received-tab" data-bs-toggle="tab" data-bs-target="#received" type="button" role="tab">
                Received Requests ({{ received_requests|length }})
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="sent-tab" data-bs-toggle="tab" data-bs-target="#sent" type="button" role="tab">
                Sent Requests ({{ sent_requests|length }})
            </button>
        </li>
    </ul>

    <div class="tab-content mt-3" id="requestsTabContent">
        <!-- Received Requests Tab -->
        <div class="tab-pane fade show active" id="received" role="tabpanel">
            {% if received_requests %}
                {% for req in received_requests %}
                    <div class="card mb-3">
                        <div class="card-body">
                            <h5 class="card-title">From: {{ req.requester.name }}</h5>

                            {% if req.message %}
                                <p class="card-text"><strong>Message:</strong> {{ req.message }}</p>
                            {% else %}
                                <p>
                                    <strong> Documents:</strong>
                                    <a href="#" onclick="toggleDocuments('{{ req.id }}', event)">
                                        {% if req.requested_files.first and req.requested_files.first.document_list_item %}
                                            {{ req.requested_files.first.document_list_item.document_list.name }} ▼
                                        {% else %}
                                            <em>Unknown List</em> ▼
                                        {% endif %}
                                    </a>
                                </p>

                                <ul id="documentList-{{ req.id }}" style="display: none; margin-left: 20px;">
                                    {% for requested_file in req.requested_files.all %}
                                        {% if requested_file.document_list_item %}
                                            <li>{{ requested_file.document_list_item.title }}</li>
                                        {% else %}
                                            <li><em>Unknown Document</em></li>
                                        {% endif %}
                                    {% empty %}
                                        <li><em>No specific documents requested.</em></li>
                                    {% endfor %}
                                </ul>
                            {% endif %}

                            <p class="text-muted"><small>Requested at: {{ req.requested_at|date:"F j, Y, g:i a" }}</small></p>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <p>No received file requests.</p>
            {% endif %}
        </div>

        <!-- Sent Requests Tab -->
        <div class="tab-pane fade" id="sent" role="tabpanel">
            {% if sent_requests %}
                {% for req in sent_requests %}
                    <div class="card mb-3">
                        <div class="card-body">
                            <h5 class="card-title">To: {{ req.receiver.name }}</h5>

                            {% if req.message %}
                                <p class="card-text"><strong>Message:</strong> {{ req.message }}</p>
                            {% else %}
                                <p>
                                    <strong> Documents:</strong>
                                    <a href="#" onclick="toggleDocuments('{{ req.id }}', event)">
                                        {% if req.requested_files.first and req.requested_files.first.document_list_item %}
                                            {{ req.requested_files.first.document_list_item.document_list.name }} ▼
                                        {% else %}
                                            <em>Unknown List</em> ▼
                                        {% endif %}
                                    </a>
                                </p>

                                <ul id="documentList-{{ req.id }}" style="display: none; margin-left: 20px;">
                                    {% for requested_file in req.requested_files.all %}
                                        {% if requested_file.document_list_item %}
                                            <li>{{ requested_file.document_list_item.title }}</li>
                                        {% else %}
                                            <li><em>Unknown Document</em></li>
                                        {% endif %}
                                    {% empty %}
                                        <li><em>No specific documents requested.</em></li>
                                    {% endfor %}
                                </ul>
                            {% endif %}

                            <p class="text-muted"><small>Requested at: {{ req.requested_at|date:"F j, Y, g:i a" }}</small></p>

                            <form method="POST" action="{% url 'delete_file_request' req.id %}" onsubmit="return confirm('Do you want to delete this request?');">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-outline-danger btn-sm">Delete</button>
                            </form>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <p>No sent file requests.</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Toggle Script -->
<script>
function toggleDocuments(id, event) {
    event.preventDefault();
    const list = document.getElementById('documentList-' + id);
    list.style.display = (list.style.display === 'none' || list.style.display === '') ? 'block' : 'none';
}
</script>
{% endblock %}
